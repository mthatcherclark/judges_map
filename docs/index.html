<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Judicial Courts by Date</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.4.0/dist/maplibre-gl.css' />
  <script src='https://unpkg.com/maplibre-gl@5.4.0/dist/maplibre-gl.js'></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    #controls {
      position: absolute;
      top: 10px; left: 10px;
      background: white; padding: 10px;
      font-family: sans-serif; z-index: 1000;
    }
    #dateLabel {
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="controls">
  <label for="courtType">Court Type:</label>
  <select id="courtType">
    <option value="U.S. District Court">Districts</option>
    <option value="U.S. Court of Appeals">Circuits</option>
  </select>
  <br><br>
  <label for="dateSlider">Date: <span id="dateLabel">1912-01-01</span></label><br>
  <input type="range" id="dateSlider" min="0" max="0" value="0" step="1" />
</div>

<div id="map"></div>

<script>
let map = new maplibregl.Map({
  container: 'map',
  style: 'https://raw.githubusercontent.com/go2garret/maps/main/src/assets/json/openStreetMap.json',
  center: [-98, 39], zoom: 3
});

let polygonsData = null;
let judgeCounts = null;

// Initial date slider values
const minDate = new Date("1912-01-01");
const maxDate = new Date();
const msPerDay = 24 * 60 * 60 * 1000;
const totalDays = Math.floor((maxDate - minDate) / msPerDay);

function daysBetween(start, end) {
  return Math.floor((end - start) / (1000 * 60 * 60 * 24));
}

function dateFromSlider(value) {
  const d = new Date(minDate.getTime());
  d.setDate(d.getDate() + parseInt(value));
  return d.toISOString().split("T")[0];
}

async function loadData() {
  const [geo, judges] = await Promise.all([
    fetch("https://mthatcherclark.github.io/judges_map/courts.geojson").then(r => r.json()),
    fetch("https://mthatcherclark.github.io/judges_map/judges.json").then(r => r.json())
  ]);
  polygonsData = geo;
  judgeCounts = judges;
  const dateSlider = document.getElementById('dateSlider');
  const dateLabel = document.getElementById('dateLabel');
  // Initialize slider
  dateSlider.min = 0;
  dateSlider.max = totalDays;
  dateSlider.value = totalDays;
  dateLabel.textContent = dateFromSlider(parseInt(dateSlider.value));
  updatePolygons();
}

function getJudgeCountOnDate(judgeData, dateStr) {
  const dates = Object.keys(judgeData).sort();
  const targetDate = new Date(dateStr);
  for (let i = dates.length - 1; i >= 0; i--) {
    if (new Date(dates[i]) <= targetDate) {
      return judgeData[dates[i]];
    }
  }
  return null;
}

function updatePolygons() {
  const courtType = document.getElementById('courtType').value;
  const sliderValue = document.getElementById('dateSlider').value;
  const dateStr = dateFromSlider(sliderValue);
  document.getElementById('dateLabel').textContent = dateStr;

  const filtered = polygonsData.features
    .filter(f => f.properties.court_type === courtType)
    .filter(f => {
      const d = new Date(dateStr);
      const start = new Date(f.properties.start_date);
      const end = new Date(f.properties.end_date);
      console.log(dateStr);  
      console.log(f.properties.start_date);
      console.log(d >= start && d <= end);      
      return d >= start && d <= end;
    })
    .map(f => {
      const cid = f.properties.court_id;
      const count = getJudgeCountOnDate(judgeCounts[cid] || {}, dateStr);
      f.properties.judge_count = (count && count[0]) || 0;
      f.properties.dem_count = (count && count[1]) || 0;
      f.properties.rep_count = (count && count[2]) || 0;
      f.properties.rep_percentage = (count && count[3]) || 0;
      return f;
    });

  const source = map.getSource('courts');
  if (source) {
    source.setData({ type: "FeatureCollection", features: filtered });
  } else {
    map.addSource('courts', {
      type: 'geojson',
      data: { type: "FeatureCollection", features: filtered }
    });
    map.addLayer({
      id: 'courts-layer',
      type: 'fill',
      source: 'courts',
      paint: {
              'fill-color': [
                'interpolate',
                ['linear'],
                ['get', 'rep_percentage'],  // This is your float, 0 to 1
                0,    '#0077FF',   // 0% Republican
                0.5,  '#800080',   // 50% Neutral (purple)
                1.0,  '#FF0000'    // 100% Republican
              ],
        'fill-opacity': 0.8,
        'fill-outline-color': '#000000'  // Small black border
      }
    });
  }
}

document.getElementById('courtType').addEventListener('change', updatePolygons);
document.getElementById('dateSlider').addEventListener('input', updatePolygons);

map.on('click', 'courts-layer', (e) => {
    const props = e.features[0].properties;
    let rep_perc = (props.rep_percentage * 100).toFixed(1) + '%';
    new maplibregl.Popup()
        .setLngLat(e.lngLat)
        .setHTML(`Court ID: ${props.court_id}<br>Total judges: ${props.judge_count}<br>DEM judges: ${props.dem_count}<br>REP judges: ${props.rep_count}<br>REP %: ${rep_perc}`)
        .addTo(map);
});

map.on('mouseenter', 'courts-layer', () => {
    map.getCanvas().style.cursor = 'pointer';
});
map.on('mouseleave', 'courts-layer', () => {
    map.getCanvas().style.cursor = '';
});

map.on('load', loadData);
</script>

</body>
</html>