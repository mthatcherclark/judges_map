<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Judicial Courts by Date</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.4.0/dist/maplibre-gl.css' />
  <script src='https://unpkg.com/maplibre-gl@5.4.0/dist/maplibre-gl.js'></script>
<!-- Fonts -->
<link rel="stylesheet" href="https://use.typekit.net/rdn8fde.css" />
<style>
  @font-face {
    font-family: "Publico Headline";
    src: url("fonts/PublicoHeadline-Black.woff2") format("woff2"),
      url("fonts/PublicoHeadline-Black.woff") format("woff");
  }

  body {
    margin: 0 !important;
  }

  a {
		text-decoration: underline;
		text-decoration-color: #A5091E;
		color: #858585;
  }

  a:hover {
    cursor: pointer;
    color: #A5091E	
  }

  a#source {
    color: #858585;
    text-decoration: none;
  }

  #container {
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #header {
    z-index: 1;
    max-width: 980px;
  }
  .title {
    font-family: "Publico Headline", Georgia, serif;
    line-height: 34px;
    font-size: 32px;
    color: rgb(0, 0, 0);
  }
  .description {
    font-family: "proxima-nova", sans-serif;
    font-size: 16px;
    line-height: 1.3;
    max-width: 980px;
    margin-top: 12px;
  }
  .legend {
    display: flex;
    align-items: center;
    font-family: "proxima-nova", sans-serif;
    font-size: 14px;
    margin-bottom: 5px;
  }
  span.legend-title {
    font-size: 16px;
    font-family: "proxima-nova", sans-serif;
  }
  .legend div {
    width: 15px;
    height: 15px;
    margin-right: 5px;
    border-radius: 2px;
  }
  .legend span {
    margin-right: 5px;
    font-family: "proxima-nova", sans-serif;
  }
  .good {
    background-color: #70bb6e;
  }

  .moderate {
    background-color: #fde633;
  }
  .unhealthy-sg {
    background-color: #fd8724;
  }
  .unhealthy {
    background-color: #a5091e;
  }
  .very-unhealthy {
    background-color: #8b09a5;
  }
  .hazardous {
    background-color: #876035;
  }
  .none {
    background-color: #cccccc;
    margin-left: 15px;
  }

  #map {
    flex-grow: 1;
    max-height: 600px;
    max-width: 980px;
    margin-bottom: 12px;
  }

  #controls {
    position: absolute;
    bottom: 10px; 
    left: 10px;
    background: white; 
    padding: 1px;
    font-family: "proxima-nova", sans-serif;
    font-size: 14px;
    border-radius: 12px;
    z-index: 1000;
  }

#time-control {
    position: absolute;
    top: 10px; 
    right: 10px;
    background: white; 
    padding: 10px;
    font-family: "proxima-nova", sans-serif;
    font-size: 14px;
    z-index: 1000;
  }


  button.maplibregl-ctrl-compass {
    display: none !important;
  }


  /* MEDIA QUERY */
  @media (max-width: 430px) {
    #map {
      max-height: 900px !important;
    }
    .description {
      margin-bottom: 10px;
    }
    .legend {
      display: flex;
      align-items: center;
      font-family: "proxima-nova", sans-serif;
      font-size: 14px;
      margin-bottom: 5px;
    }
    span.legend-title {
      font-size: 14px;
      font-family: "proxima-nova", sans-serif;
    }
    .legend div {
      width: 15px;
      height: 15px;
      margin-right: 4px;
      border-radius: 2px;
    }
    .legend span {
      font-family: "proxima-nova", sans-serif;
    }
    .none {
      background-color: #cccccc;
      margin-left: 10px;
    }
  }

  .note {
    font-family: "proxima-nova", sans-serif;
    font-size: 16px;
  }

  .source {
    font-family: "proxima-nova", sans-serif;
    color: rgb(130, 130, 130);
    font-size: 14px;
  }

  a#source {
    color: rgb(130, 130, 130);
    text-decoration: underline;
  }
  #dateLabel {
    font-weight: bold;
  }
  .toggle-btn {
    padding: 8px 16px;
    background-color: #eee;
    border: 1px solid #aaa;
    border-radius: 4px;
    cursor: pointer;
  }
  .toggle-btn.active {
    background-color: #007BFF;
    color: white;
    border-color: #007BFF;
  }
.switch {
  position: relative;
  display: inline-block;
  width: 40px;
  height: 21px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  background-color: white;
  border: 1px solid #ccc;
  transition: 0.4s;
  border-radius: 21px;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
}

.slider:before {
  content: "";
  position: absolute;
  height: 16px;
  width: 16px;
  left: 1px;
  bottom: 1px;
  background-color: gray;
  transition: 0.4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #2196F3; /* blue when on */
}

input:checked + .slider:before {
  transform: translateX(24px);
  background-color: white;
}
</style>
</head>
<body>

  <div id="container">
  <div id="header">
    <div class="title">Nominating political party of federal judges</div>
    <p class="description">
      This map shows which political party's president nominated the judges in each federal court circuit or district court. Legal experts interviewed by CBS News said plaintiffs seeking nationwide reforms 
      often consider this information when deciding where to file their cases. Click 
      <a href="https://www.uscourts.gov/about-federal-courts/educational-resources/supreme-court-landmarks/nomination-process" target="_blank">here</a> to learn more about the judicial nomination 
      process.
    </p>
    <div class="legend">
      <span>Good</span>
      <div class="good"></div>
      <div class="moderate"></div>
      <div class="unhealthy-sg"></div>
      <div class="unhealthy"></div>
      <div class="very-unhealthy"></div>
      <div class="hazardous"></div>
      <span>Hazardous</span>
      <div class="none"></div>
      <span>No data</span>
    </div>
  </div>

  <div id="map">

    <div id="controls">
      <label for="courtType">Circuits: </label>
      <label class="switch"> 
        <input type="checkbox" id="courtType">
        <span class="slider"></span>
      </label>
      <br>
      <label for="seniorsToggle">Senior judges: </label>
      <label class="switch"> 
        <input type="checkbox" id="seniorsToggle">
        <span class="slider"></span>
      </label>

      <!-- <button id="typeToggle" class="toggle-btn">Circuits</button>
      <br> -->
      <!-- <button id="seniorsToggle" class="toggle-btn">Senior Judges</button> -->
      <!-- <br>
      <label for="dateSlider">Date: <span id="dateLabel">1912-01-01</span></label><br>
      <input type="range" id="dateSlider" min="0" max="0" value="0" step="1" /> -->
    </div>
    
    <div id="time-control">
      <label for="dateSlider"><span id="dateLabel">Jan. 1, 1912</span></label><br>
      <input type="range" id="dateSlider" min="0" max="0" value="0" step="1" />
    </div>


  </div>
  <div class="note"></div>
  <div class="source">
    Sources:
    <a
      href="https://www.fjc.gov/history/judges"
      target="_blank" id="source"
      >FJC,</a> 
    <a
      href="https://doi.org/10.3886/E30426V1"
      target="_blank" id="source"
      >ICPSR,</a> 
    <a
      href="https://data.ojp.usdoj.gov/Shapefile/US-Attorney-Districts-Shapefile-simplified/vigs-nsnz/about_data"
      target="_blank" id="source"
      >U.S. DOJ</a>
  </div>
</div>

<script>
function formatAPStyleFromISO(isoDateStr) {
  const months = [
    "Jan.", "Feb.", "March", "April", "May", "June",
    "July", "Aug.", "Sept.", "Oct.", "Nov.", "Dec."
  ];

  const date = new Date(isoDateStr);
  if (isNaN(date)) return "Invalid date";

  const day = date.getDate();
  const month = months[date.getMonth()];
  const year = date.getFullYear();

  return `${month} ${day}, ${year}`;
}

let map = new maplibregl.Map({
  container: 'map',
  // style: "https://vapi.mc-cdn.io/styles/CTS%20Flat%20Map.json?access_token=u3Q9ykMVHQIvvHegtpo2qgbyUxXbtw2N9e8983fde25feff58982455e437cb67145892361", //CBS Flat
  // style: "https://vapi.mc-cdn.io/styles/CBS%20Web.json?access_token=u3Q9ykMVHQIvvHegtpo2qgbyUxXbtw2N9e8983fde25feff58982455e437cb67145892361", // CBS Web
  style: "https://raw.githubusercontent.com/go2garret/maps/main/src/assets/json/openStreetMap.json",
  center: [-96, 36], // Centered on the United States
  zoom: 5,
  maxZoom: 7,
  minZoom: 2,
});

let polygonsData = null;
let judgeCounts = null;

// Disable scroll zoom
map.scrollZoom.disable();

// Add zoom and rotation controls to the map.
map.addControl(new maplibregl.NavigationControl(), "top-left");

// Initial date slider values
const minDate = new Date("1912-01-01");
const maxDate = new Date();
const msPerDay = 24 * 60 * 60 * 1000;
const totalDays = Math.floor((maxDate - minDate) / msPerDay);

function daysBetween(start, end) {
  return Math.floor((end - start) / (1000 * 60 * 60 * 24));
}

function dateFromSlider(value) {
  const d = new Date(minDate.getTime());
  d.setDate(d.getDate() + parseInt(value));
  return d.toISOString().split("T")[0];
}

async function loadData() {
  // Fit the continguous in screen regardless of size
  // with a fun animation!
  map.fitBounds(
    [
      [-125, 24], // Southwest corner [lng, lat]
      [-66.5, 49] // Northeast corner [lng, lat]
    ],
    {
      padding: 10, // Adjust for your UI needs
      animate: true,
      duration: 1000 // Optional: smooth transition
    }
  );

  // Load GeoJSON data and judge counts
  const [geo, judges] = await Promise.all([
    fetch("https://mthatcherclark.github.io/judges_map/courts.geojson").then(r => r.json()),
    fetch("https://mthatcherclark.github.io/judges_map/judges.json").then(r => r.json())
  ]);
  polygonsData = geo;
  judgeCounts = judges;
  
  // Initialize slider
  const dateSlider = document.getElementById('dateSlider');
  const dateLabel = document.getElementById('dateLabel');

  dateSlider.min = 0;
  dateSlider.max = totalDays;
  dateSlider.value = totalDays;
  dateLabel.textContent = formatAPStyleFromISO(dateFromSlider(parseInt(dateSlider.value)));
  
  updatePolygons();
}

function getJudgeCountOnDate(judgeData, dateStr) {
  const dates = Object.keys(judgeData).sort();
  const targetDate = new Date(dateStr);
  for (let i = dates.length - 1; i >= 0; i--) {
    if (new Date(dates[i]) <= targetDate) {
      return judgeData[dates[i]];
    }
  }
  return null;
}

function updatePolygons() {
  const court_box = document.getElementById('courtType');
  const courtType = court_box.checked ? "U.S. Court of Appeals" : "U.S. District Court";

  const seniors_box = document.getElementById('seniorsToggle');
  const incSeniors = seniors_box.checked ? true : false;
  // const courtType = type_button.classList.contains("active")
  //   ? "U.S. Court of Appeals"
  //   : "U.S. District Court";
  // const incSeniors = seniors_button.classList.contains("active")
  //   ? true
  //   : false;

  const sliderValue = document.getElementById('dateSlider').value;
  const dateStr = dateFromSlider(sliderValue);
  document.getElementById('dateLabel').textContent = formatAPStyleFromISO(dateStr);

  const filtered = polygonsData.features
    .filter(f => f.properties.court_type === courtType)
    .filter(f => {
      const d = new Date(dateStr);
      const start = new Date(f.properties.start_date);
      const end = new Date(f.properties.end_date);     
      return d >= start && d <= end;
    })
    .map(f => {
      const cid = f.properties.court_id;
      const count = getJudgeCountOnDate(judgeCounts[cid] || {}, dateStr);
      f.properties.judge_count = (count && count[0]) || 0;
      f.properties.dem_count = (count && count[1]) || 0;
      f.properties.rep_count = (count && count[2]) || 0;
      f.properties.rep_percentage = (count && count[3]) || 0;
      return f;
    });

  const source = map.getSource('courts');
  if (source) {
    source.setData({ type: "FeatureCollection", features: filtered });
  } else {
    map.addSource('courts', {
      type: 'geojson',
      data: { type: "FeatureCollection", features: filtered }
    });
    map.addLayer({
      id: 'courts-layer',
      type: 'fill',
      source: 'courts',
      paint: {
              'fill-color': [
                'interpolate',
                ['linear'],
                ['get', 'rep_percentage'],  // This is your float, 0 to 1
                0,    '#0077FF',   // 0% Republican
                0.5,  '#800080',   // 50% Neutral (purple)
                1.0,  '#FF0000'    // 100% Republican
              ],
        'fill-opacity': 0.8,
        'fill-outline-color': '#000000'  // Small black border
      }
    });
  }
}

// const type_button = document.getElementById("typeToggle");
//   type_button.addEventListener("click", () => {
//     type_button.classList.toggle("active");
//     updatePolygons();
// });

// const seniors_button = document.getElementById("seniorsToggle");
//   seniors_button.addEventListener("click", () => {
//     seniors_button.classList.toggle("active");
//     updatePolygons();
// });

document.getElementById('courtType').addEventListener('change', updatePolygons);
document.getElementById('seniorsToggle').addEventListener('change', updatePolygons);
document.getElementById('dateSlider').addEventListener('input', updatePolygons);

map.on('click', 'courts-layer', (e) => {
    const props = e.features[0].properties;
    let rep_perc = (props.rep_percentage * 100).toFixed(1) + '%';
    new maplibregl.Popup()
        .setLngLat(e.lngLat)
        .setHTML(`Court ID: ${props.court_id}<br>Total judges: ${props.judge_count}<br>DEM judges: ${props.dem_count}<br>REP judges: ${props.rep_count}<br>REP %: ${rep_perc}`)
        .addTo(map);
});

map.on('mouseenter', 'courts-layer', () => {
    map.getCanvas().style.cursor = 'pointer';
});
map.on('mouseleave', 'courts-layer', () => {
    map.getCanvas().style.cursor = '';
});

map.on('load', loadData);
</script>

</body>
</html>