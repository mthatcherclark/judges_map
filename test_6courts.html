<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Judicial Courts by Date</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    #controls {
      position: absolute;
      top: 10px; left: 10px;
      background: white; padding: 10px;
      font-family: sans-serif; z-index: 1000;
    }
  </style>
</head>
<body>

<div id="controls">
  <label for="courtType">Court Type:</label>
  <select id="courtType">
    <option value="district">District</option>
    <option value="circuit">Circuit</option>
  </select>
  <br>
  <label for="dateSlider">Date:</label>
  <input type="date" id="dateSlider" value="1900-01-01" min="1900-01-01" max="2020-01-01" />
</div>

<div id="map"></div>

<script>
let map = new maplibregl.Map({
  container: 'map',
  style: 'https://demotiles.maplibre.org/style.json',
  center: [-98, 39], zoom: 3
});

let polygonsData = null;
let judgeCounts = null;

async function loadData() {
  const [geo, judges] = await Promise.all([
    fetch("courts.geojson").then(r => r.json()),
    fetch("judge_counts.json").then(r => r.json())
  ]);
  polygonsData = geo;
  judgeCounts = judges;
  updatePolygons();
}

function getJudgeCountOnDate(judgeData, dateStr) {
  const dates = Object.keys(judgeData).sort();
  for (let i = dates.length - 1; i >= 0; i--) {
    if (new Date(dates[i]) <= new Date(dateStr)) {
      return judgeData[dates[i]];
    }
  }
  return null;
}

function updatePolygons() {
  const courtType = document.getElementById('courtType').value;
  const dateStr = document.getElementById('dateSlider').value;

  const filtered = polygonsData.features
    .filter(f => f.properties.court_type === courtType)
    .filter(f => {
      const d = new Date(dateStr);
      const start = new Date(f.properties.start_date);
      const end = new Date(f.properties.end_date);
      return d >= start && d <= end;
    })
    .map(f => {
      const cid = f.properties.court_id;
      const count = getJudgeCountOnDate(judgeCounts[cid] || {}, dateStr);
      f.properties.judge_count = count || 0;
      return f;
    });

  const source = map.getSource('courts');
  if (source) {
    source.setData({ type: "FeatureCollection", features: filtered });
  } else {
    map.addSource('courts', {
      type: 'geojson',
      data: { type: "FeatureCollection", features: filtered }
    });
    map.addLayer({
      id: 'courts-layer',
      type: 'fill',
      source: 'courts',
      paint: {
        'fill-color': [
          'interpolate',
          ['linear'],
          ['get', 'judge_count'],
          0, '#f0f9e8',
          10, '#bae4bc',
          20, '#7bccc4',
          30, '#2b8cbe'
        ],
        'fill-opacity': 0.7
      }
    });
  }
}

document.getElementById('courtType').addEventListener('change', updatePolygons);
document.getElementById('dateSlider').addEventListener('input', updatePolygons);

map.on('load', loadData);
</script>

</body>
</html>
